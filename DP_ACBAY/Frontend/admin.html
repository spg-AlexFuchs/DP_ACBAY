<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EVN AG | Admin Panel</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <div class="mx-auto max-w-7xl p-6 md:p-10">
    <header class="rounded-2xl bg-gradient-to-r from-slate-950 via-slate-800 to-emerald-900 p-8 text-white shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="inline-flex rounded-full border border-emerald-300/40 bg-emerald-500/20 px-3 py-1 text-xs font-semibold tracking-wide">Admin</div>
          <h1 class="mt-4 text-3xl font-bold">Admin-Panel (RBAC)</h1>
          <p class="mt-2 text-sm text-slate-200">Nur ADMIN und SUPER_ADMIN. Funktionen: Rollen, Datenqualitaet, Audit, Exporte, Uploads.</p>
        </div>
        <div class="text-right">
          <div id="whoami" class="text-sm text-slate-200">Pruefe Zugriff...</div>
          <a href="index.html" class="mt-2 inline-block text-sm font-semibold text-emerald-200 hover:text-white">Zurueck zum Dashboard</a>
        </div>
      </div>
    </header>

    <section class="mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <button id="btnExportCsv" class="rounded-xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">Export CSV</button>
      <button id="btnExportXlsx" class="rounded-xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">Export XLSX</button>
      <button id="btnExportPdf" class="rounded-xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">Export PDF</button>
      <button id="btnRefresh" class="rounded-xl bg-emerald-700 px-4 py-3 text-sm font-semibold text-white hover:bg-emerald-600">Alles aktualisieren</button>
    </section>

    <section class="mt-6 grid gap-6 xl:grid-cols-12">
      <article class="rounded-2xl bg-white p-5 shadow xl:col-span-5">
        <h2 class="text-lg font-semibold">Benutzer und Rollen</h2>
        <p class="mt-1 text-xs text-slate-500">Rollenwechsel wird im Audit-Log dokumentiert.</p>

        <form id="roleForm" class="mt-4 grid gap-2 md:grid-cols-3">
          <input id="roleUserId" type="number" min="1" placeholder="User-ID" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" required />
          <select id="roleValue" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" required>
            <option value="EMPLOYEE">EMPLOYEE</option>
            <option value="HR">HR</option>
            <option value="ADMIN">ADMIN</option>
            <option value="SUPER_ADMIN">SUPER_ADMIN</option>
          </select>
          <button type="submit" class="rounded-lg bg-emerald-700 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-600">Rolle setzen</button>
        </form>

        <div class="mt-3 overflow-x-auto rounded-xl border border-slate-200">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-slate-100 text-xs uppercase tracking-wide text-slate-600">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">Email</th>
                <th class="px-3 py-2">Name</th>
                <th class="px-3 py-2">Rolle</th>
                <th class="px-3 py-2">Surveys</th>
                <th class="px-3 py-2">Erstellt</th>
              </tr>
            </thead>
            <tbody id="adminUsersRows" hx-get="http://localhost:3000/admin/partials/users" hx-trigger="load, adminRefresh from:body" hx-swap="innerHTML">
              <tr><td colspan="6" class="px-3 py-3 text-center text-slate-500">Lade...</td></tr>
            </tbody>
          </table>
        </div>
      </article>

      <article class="rounded-2xl bg-white p-5 shadow xl:col-span-7">
        <h2 class="text-lg font-semibold">Datenvalidierung / Korrektur</h2>
        <p class="mt-1 text-xs text-slate-500">Direkte Korrektur einzelner Survey-Felder (Admin).</p>

        <form id="surveyPatchForm" class="mt-4 grid gap-2 md:grid-cols-5">
          <input id="patchSurveyId" type="number" min="1" placeholder="Survey-ID" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" required />
          <select id="patchField" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" required>
            <option value="distanceKm">distanceKm</option>
            <option value="officeDaysPerWeek">officeDaysPerWeek</option>
            <option value="transportMain">transportMain</option>
            <option value="flightsPerYear">flightsPerYear</option>
            <option value="totalCo2Kg">totalCo2Kg</option>
            <option value="heatingType">heatingType</option>
          </select>
          <input id="patchValue" type="text" placeholder="Neuer Wert" class="rounded-lg border border-slate-300 px-3 py-2 text-sm md:col-span-2" required />
          <button type="submit" class="rounded-lg bg-emerald-700 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-600">Speichern</button>
        </form>

        <div id="adminMessage" class="mt-3 min-h-[1.25rem] text-sm"></div>
      </article>
    </section>

    <section class="mt-6 grid gap-6 xl:grid-cols-12">
      <article class="rounded-2xl bg-white p-5 shadow xl:col-span-6">
        <h2 class="text-lg font-semibold">Datei-Upload</h2>
        <p class="mt-1 text-xs text-slate-500">Zusatzdateien fuer Admin-Workflow (max 25MB).</p>

        <form id="uploadForm" class="mt-4 flex flex-wrap gap-2">
          <input id="uploadFile" type="file" class="rounded-lg border border-slate-300 px-3 py-2 text-sm" required />
          <button type="submit" class="rounded-lg bg-emerald-700 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-600">Upload</button>
        </form>

        <div class="mt-3 overflow-x-auto rounded-xl border border-slate-200">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-slate-100 text-xs uppercase tracking-wide text-slate-600">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">Datei</th>
                <th class="px-3 py-2">Groesse</th>
                <th class="px-3 py-2">Benutzer</th>
                <th class="px-3 py-2">Zeit</th>
              </tr>
            </thead>
            <tbody id="adminUploadsRows" hx-get="http://localhost:3000/admin/partials/uploads" hx-trigger="load, adminRefresh from:body" hx-swap="innerHTML">
              <tr><td colspan="5" class="px-3 py-3 text-center text-slate-500">Lade...</td></tr>
            </tbody>
          </table>
        </div>
      </article>

      <article class="rounded-2xl bg-white p-5 shadow xl:col-span-6">
        <h2 class="text-lg font-semibold">Audit-Log</h2>
        <p class="mt-1 text-xs text-slate-500">Wer, wann, was geaendert hat (revisionssicher).</p>

        <div class="mt-3 overflow-x-auto rounded-xl border border-slate-200">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-slate-100 text-xs uppercase tracking-wide text-slate-600">
              <tr>
                <th class="px-3 py-2">ID</th>
                <th class="px-3 py-2">Akteur</th>
                <th class="px-3 py-2">Aktion</th>
                <th class="px-3 py-2">Typ</th>
                <th class="px-3 py-2">Ziel</th>
                <th class="px-3 py-2">Zeit</th>
              </tr>
            </thead>
            <tbody id="adminAuditRows" hx-get="http://localhost:3000/admin/partials/audit-logs" hx-trigger="load, adminRefresh from:body" hx-swap="innerHTML">
              <tr><td colspan="6" class="px-3 py-3 text-center text-slate-500">Lade...</td></tr>
            </tbody>
          </table>
        </div>
      </article>
    </section>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    const token = localStorage.getItem("token");
    const whoami = document.getElementById("whoami");
    const msg = document.getElementById("adminMessage");

    function setMessage(text, error = false) {
      msg.textContent = text;
      msg.className = error ? "mt-3 min-h-[1.25rem] text-sm text-red-700" : "mt-3 min-h-[1.25rem] text-sm text-emerald-700";
    }

    function ensureAuthHeader(event) {
      if (token) event.detail.headers.Authorization = `Bearer ${token}`;
    }

    async function requireAdmin() {
      if (!token) {
        window.location.href = "index.html";
        return false;
      }
      const res = await fetch(`${API_URL}/me`, { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        window.location.href = "index.html";
        return false;
      }
      const me = await res.json();
      whoami.textContent = `${me.email} (${me.role})`;
      if (!(me.role === "ADMIN" || me.role === "SUPER_ADMIN")) {
        setMessage("Kein Admin-Zugriff.", true);
        window.location.href = "index.html";
        return false;
      }
      return true;
    }

    async function setRole(event) {
      event.preventDefault();
      const userId = document.getElementById("roleUserId").value;
      const role = document.getElementById("roleValue").value;
      const res = await fetch(`${API_URL}/admin/users/${userId}/role`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ role }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return setMessage(data.error || "Rollenupdate fehlgeschlagen", true);
      setMessage(`Rolle aktualisiert: ${data.email} -> ${data.role}`);
      htmx.trigger("body", "adminRefresh");
    }

    function castValue(field, raw) {
      if (["distanceKm", "totalCo2Kg"].includes(field)) return Number(raw);
      if (["officeDaysPerWeek", "flightsPerYear"].includes(field)) return parseInt(raw, 10);
      return raw;
    }

    async function patchSurvey(event) {
      event.preventDefault();
      const id = document.getElementById("patchSurveyId").value;
      const field = document.getElementById("patchField").value;
      const value = castValue(field, document.getElementById("patchValue").value);
      const res = await fetch(`${API_URL}/admin/surveys/${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ [field]: value }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return setMessage(data.error || "Survey-Update fehlgeschlagen", true);
      setMessage(`Survey #${id} aktualisiert (${field}).`);
      htmx.trigger("body", "adminRefresh");
    }

    async function uploadFile(event) {
      event.preventDefault();
      const fileInput = document.getElementById("uploadFile");
      if (!fileInput.files.length) return;
      const fd = new FormData();
      fd.append("file", fileInput.files[0]);

      const res = await fetch(`${API_URL}/admin/upload`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return setMessage(data.error || "Upload fehlgeschlagen", true);
      setMessage(`Datei hochgeladen: ${data.originalName}`);
      fileInput.value = "";
      htmx.trigger("body", "adminRefresh");
    }

    async function downloadExport(path, fallbackName) {
      const res = await fetch(`${API_URL}${path}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        return setMessage(data.error || "Export fehlgeschlagen", true);
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const contentDisposition = res.headers.get("Content-Disposition") || "";
      const fileNameMatch = contentDisposition.match(/filename="([^"]+)"/);
      a.href = url;
      a.download = fileNameMatch ? fileNameMatch[1] : fallbackName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setMessage(`Export erstellt: ${a.download}`);
    }

    document.body.addEventListener("htmx:configRequest", ensureAuthHeader);
    document.getElementById("roleForm").addEventListener("submit", setRole);
    document.getElementById("surveyPatchForm").addEventListener("submit", patchSurvey);
    document.getElementById("uploadForm").addEventListener("submit", uploadFile);
    document.getElementById("btnRefresh").addEventListener("click", () => htmx.trigger("body", "adminRefresh"));
    document.getElementById("btnExportCsv").addEventListener("click", () => downloadExport("/admin/export.csv", "surveys.csv"));
    document.getElementById("btnExportXlsx").addEventListener("click", () => downloadExport("/admin/export.xlsx", "surveys.xlsx"));
    document.getElementById("btnExportPdf").addEventListener("click", () => downloadExport("/admin/export.pdf", "surveys.pdf"));

    requireAdmin();
  </script>
</body>
</html>
